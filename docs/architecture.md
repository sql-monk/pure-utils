# Архітектура pure-utils

## Огляд системи

pure-utils побудований за модульним принципом і складається з декількох взаємопов'язаних компонентів, які разом формують повноцінну екосистему для управління та оптимізації SQL Server.

## Діаграма компонентів

```
┌─────────────────────────────────────────────────────────────────┐
│                      AI-асистенти (Claude, etc)                 │
└────────────────────────┬────────────────────────────────────────┘
                         │ MCP Protocol (JSON-RPC)
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    MCP Сервери (.NET 8)                         │
│  ┌──────────────────────┐      ┌──────────────────────┐         │
│  │   PureSqlsMcp        │      │   PlanSqlsMcp        │         │
│  │  (метадані БД)       │      │  (плани виконання)   │         │
│  └──────────────────────┘      └──────────────────────┘         │
└────────────────────────┬────────────────────────────────────────┘
                         │ ADO.NET / SqlClient
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   SQL Server Database                           │
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Схема mcp - MCP адаптери (JSON responses)                 │ │
│  │  • GetDatabases, GetTables, GetViews                       │ │
│  │  • GetTableInfo, GetDdlHistory                             │ │
│  │  • ScriptObjectAndReferences                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                           │ викликає                            │
│                           ▼                                     │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Схема util - Основна бібліотека (100+ об'єктів)           │ │
│  │                                                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │  Метадані    │  │   Індекси    │  │  SQL Код     │      │ │
│  │  │  Functions   │  │  Functions   │  │  Functions   │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  │                                                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │ │
│  │  │  XE Events   │  │  DDL Script  │  │  Utilities   │      │ │
│  │  │  Functions   │  │  Functions   │  │  Functions   │      │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │ │
│  │                                                            │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │  Tables (Audit & Monitoring)                        │   │ │
│  │  │  • errorLog, eventsNotifications                    │   │ │
│  │  │  • executionModulesUsers, executionSqlText          │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Extended Events Sessions                                  │ │
│  │  • utilsErrors - моніторинг помилок                        │ │
│  │  • utilsModulesUsers - виконання модулів                   │ │
│  │  • utilsDebug - debug події                                │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                         ▲
                         │ PowerShell / dbatools
                         │
┌─────────────────────────────────────────────────────────────────┐
│              Розгортання та Build скрипти                       │
│  • deployUtil.ps1 - розгортання з залежностями                  │
│  • build.ps1 - компіляція MCP серверів                          │
└─────────────────────────────────────────────────────────────────┘
```

## Потік даних

### 1. Запит через AI-асистента (MCP)

```
AI-асистент → MCP Server → mcp.GetTableInfo 
  → util.metadataGetColumns + util.metadataGetIndexes 
  → Системні каталоги SQL Server → JSON Response
```

### 2. Прямий виклик з T-SQL

```
T-SQL Query → util.indexesGetMissing 
  → sys.dm_db_missing_index_* DMVs 
  → Результуюча таблиця з рекомендаціями
```

### 3. Моніторинг через Extended Events

```
SQL Server Events → XE Session (utilsModulesUsers) 
  → XE Target Files → util.xeGetModules 
  → util.xeCopyModulesToTable 
  → util.executionModulesUsers (таблиця)
```

## Основні залежності

### Внутрішні залежності

1. **Схема mcp залежить від схеми util**
   - Всі процедури mcp викликають функції util
   - mcp формує JSON обгортки навколо util функцій

2. **Функції util використовують системні каталоги**
   - `sys.objects`, `sys.indexes`, `sys.columns`
   - `sys.dm_*` - динамічні представлення управління
   - `sys.fn_*` - системні функції

3. **Extended Events → util таблиці**
   - XE сесії записують у файли
   - Функції `util.xeGet*` читають файли
   - Процедури `util.xeCopyModulesToTable` копіюють у таблиці

### Зовнішні залежності

1. **PowerShell + dbatools**
   - Використовується для розгортання об'єктів
   - Автоматичне вирішення залежностей між об'єктами

2. **.NET SDK 8.0** (опціонально)
   - Для компіляції MCP серверів
   - Використовує Microsoft.Data.SqlClient

3. **MCP Protocol** (опціонально)
   - Стандарт для комунікації з AI-асистентами
   - JSON-RPC 2.0 over stdio

## Модулі та їх призначення

### Схема util - Основна бібліотека

#### 1. Модуль Metadata

**Призначення**: Робота з метаданими об'єктів бази даних

**Ключові функції**:
- `metadataGetAnyId` - універсальне отримання ID будь-якого об'єкта
- `metadataGetAnyName` - універсальне отримання назви по ID
- `metadataGetColumns` - інформація про колонки таблиці
- `metadataGetDescriptions` - отримання MS_Description

**Використання**: Базова функціональність для інших модулів

#### 2. Модуль Indexes

**Призначення**: Аналіз та оптимізація індексів

**Ключові функції**:
- `indexesGetMissing` - пошук відсутніх індексів
- `indexesGetUnused` - виявлення невикористовуваних індексів
- `indexesGetConventionNames` - генерація стандартизованих назв
- `indexesGetSpaceUsed` - аналіз використання дискового простору

**Використання**: Оптимізація продуктивності, обслуговування індексів

#### 3. Модуль Modules (SQL Code)

**Призначення**: Парсинг та аналіз SQL коду

**Ключові функції**:
- `modulesRecureSearchForOccurrences` - рекурсивний пошук входжень
- `modulesFindCommentsPositions` - виділення коментарів
- `modulesSplitToLines` - розбиття на рядки
- `modulesFindSimilar` - пошук схожих модулів

**Використання**: Аналіз залежностей, рефакторинг, документування

#### 4. Модуль XE (Extended Events)

**Призначення**: Моніторинг через Extended Events

**Ключові функції**:
- `xeGetErrors` - читання помилок з XE файлів
- `xeGetModules` - читання виконань модулів
- `xeCopyModulesToTable` - копіювання у таблиці

**Використання**: Моніторинг, профілювання, аудит

#### 5. Модуль DDL Scripts

**Призначення**: Генерація DDL скриптів

**Ключові функції**:
- `tablesGetScript` - DDL таблиць
- `objesctsScriptWithDependencies` - скрипти з залежностями

**Використання**: Міграції, документування, version control

### Схема mcp - AI адаптери

**Призначення**: JSON обгортки для MCP протоколу

**Ключові процедури**:
- `GetDatabases`, `GetTables`, `GetViews` - списки об'єктів
- `GetTableInfo` - детальна інформація про таблицю
- `ScriptObjectAndReferences` - генерація DDL

**Використання**: Інтеграція з AI-асистентами через MCP

### MCP сервери (.NET)

#### PureSqlsMcp

**Призначення**: Динамічна генерація MCP tools з процедур

**Особливості**:
- Автоматичне виявлення процедур схеми mcp
- Витягування параметрів та типів
- Генерація JSON схем для MCP tools

#### PlanSqlsMcp

**Призначення**: Аналіз планів виконання

**Особливості**:
- Отримання estimated execution plans
- Очищення від службових команд SHOWPLAN
- Підтримка батчів

## Обмеження та передумови

### Системні вимоги

- SQL Server 2016+ (деякі функції вимагають 2019+)
- Права `db_owner` для встановлення
- Extended Events доступні (для моніторингу)

### Продуктивність

- Функції metadata оптимізовані для частого виклику
- Функції аналізу індексів можуть бути ресурсомісткими на великих БД
- XE сесії мають мінімальний вплив на продуктивність

### Обмеження

- Не підтримуються Azure SQL Database managed instances (частково)
- Деякі функції потребують специфічних прав (VIEW SERVER STATE)
- Cross-database залежності вимагають прав SELECT на цільові БД

## Розширення та кастомізація

### Додавання власних функцій у схему util

1. Створіть SQL файл у відповідній папці (`Functions`, `Procedures`)
2. Дотримуйтесь конвенцій найменування (див. [Стиль коду](coding-style.md))
3. Додайте структуровані коментарі
4. Розгорніть через `deployUtil.ps1`

### Створення нових MCP tools

1. Створіть процедуру у схемі mcp
2. Додайте структуровані коментарі з описом параметрів
3. Поверніть JSON у форматі MCP response
4. Перекомпілюйте PureSqlsMcp

### Налаштування XE сесій

1. Скопіюйте існуючу сесію з `XESessions/`
2. Налаштуйте фільтри та action
3. Створіть відповідну функцію `util.xeGetYourSession`

## Best Practices

1. **Використовуйте мінімальні права доступу** для production середовищ
2. **Регулярно перевіряйте рекомендації** з `indexesGetMissing`
3. **Моніторьте розмір XE файлів** та налаштуйте ротацію
4. **Використовуйте транзакції** при виконанні DDL скриптів
5. **Тестуйте на dev середовищі** перед застосуванням на production

## Наступні кроки

- Детальна документація модулів: [util](modules/util.md), [mcp](modules/mcp.md)
- Практичні приклади: [Приклади](examples.md)
- Конфігурація MCP: [Конфігурація](config.md)
