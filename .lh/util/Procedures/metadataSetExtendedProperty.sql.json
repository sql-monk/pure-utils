{
    "sourceFile": "util/Procedures/metadataSetExtendedProperty.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1757964521480,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757964532322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,9 @@\n \r\n \t-- Перевірка на існування extended property\r\n \tIF NOT EXISTS (\r\n \t\tSELECT * \r\n-\t\tFROM sys.extended_properties (NOLOCK) \r\n+\t\tFROM sys.extended_properties\r\n \t\tWHERE name = @name \r\n \t\t\tAND ISNULL(@level0type, 'DATABASE') = 'DATABASE'\r\n \t\t\tAND ISNULL(@level1type, '') = ISNULL(@level1type, '')\r\n \t\t\tAND ISNULL(@level1name, '') = ISNULL(@level1name, '')\r\n"
                },
                {
                    "date": 1757964849609,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,20 +1,18 @@\n-USE model; \r\n-GO\r\n CREATE OR ALTER PROCEDURE [util].[metadataSetExtendedProperty]\r\n \t@name NVARCHAR(128),\r\n-\t@value sql_variant = NULL,\r\n-\t@level0type VARCHAR(128) = NULL,\r\n+\t@value NVARCHAR(max) = NULL,\r\n+\t@level0type NVARCHAR(128) = NULL,\r\n \t@level0name NVARCHAR(128) = NULL,\r\n-\t@level1type VARCHAR(128) = NULL,\r\n+\t@level1type NVARCHAR(128) = NULL,\r\n \t@level1name NVARCHAR(128) = NULL,\r\n-\t@level2type VARCHAR(128) = NULL,\r\n+\t@level2type NVARCHAR(128) = NULL,\r\n \t@level2name NVARCHAR(128) = NULL\r\n AS\r\n BEGIN\r\n \tSET NOCOUNT ON;\r\n \tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n-\r\n+\tDECLARE @varVal VARCHAR(max) = @value\r\n \t-- Перевірка на існування extended property\r\n \tIF NOT EXISTS (\r\n \t\tSELECT * \r\n \t\tFROM sys.extended_properties\r\n@@ -28,9 +26,9 @@\n \tBEGIN\r\n \t\t-- Додавання нового extended property\r\n \t\tEXEC sys.sp_addextendedproperty\r\n \t\t\t@name = @name,\r\n-\t\t\t@value = @value,\r\n+\t\t\t@value = @varVal,\r\n \t\t\t@level0type = @level0type,\r\n \t\t\t@level0name = @level0name,\r\n \t\t\t@level1type = @level1type,\r\n \t\t\t@level1name = @level1name,\r\n@@ -41,14 +39,13 @@\n \tBEGIN\r\n \t\t-- Оновлення існуючого extended property\r\n \t\tEXEC sys.sp_updateextendedproperty\r\n \t\t\t@name = @name,\r\n-\t\t\t@value = @value,\r\n+\t\t\t@value = @varVal,\r\n \t\t\t@level0type = @level0type,\r\n \t\t\t@level0name = @level0name,\r\n \t\t\t@level1type = @level1type,\r\n \t\t\t@level1name = @level1name,\r\n \t\t\t@level2type = @level2type,\r\n \t\t\t@level2name = @level2name;\r\n \tEND\r\n END;\r\n\\ No newline at end of file\n-GO\n"
                },
                {
                    "date": 1757964856235,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-CREATE OR ALTER PROCEDURE [util].[metadataSetExtendedProperty]\r\n+CREATE PROCEDURE [util].[metadataSetExtendedProperty]\r\n \t@name NVARCHAR(128),\r\n \t@value NVARCHAR(max) = NULL,\r\n \t@level0type NVARCHAR(128) = NULL,\r\n \t@level0name NVARCHAR(128) = NULL,\r\n@@ -47,5 +47,5 @@\n \t\t\t@level1name = @level1name,\r\n \t\t\t@level2type = @level2type,\r\n \t\t\t@level2name = @level2name;\r\n \tEND\r\n-END;\n\\ No newline at end of file\n+END;\r\n"
                },
                {
                    "date": 1757964946488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-CREATE PROCEDURE [util].[metadataSetExtendedProperty]\r\n+CREATE OR ALTER PROCEDURE [util].[metadataSetExtendedProperty]\r\n \t@name NVARCHAR(128),\r\n \t@value NVARCHAR(max) = NULL,\r\n \t@level0type NVARCHAR(128) = NULL,\r\n \t@level0name NVARCHAR(128) = NULL,\r\n@@ -10,9 +10,9 @@\n AS\r\n BEGIN\r\n \tSET NOCOUNT ON;\r\n \tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n-\tDECLARE @varVal VARCHAR(max) = @value\r\n+\tDECLARE @varVal VARCHAR(4000) = @value\r\n \t-- Перевірка на існування extended property\r\n \tIF NOT EXISTS (\r\n \t\tSELECT * \r\n \t\tFROM sys.extended_properties\r\n@@ -48,4 +48,5 @@\n \t\t\t@level2type = @level2type,\r\n \t\t\t@level2name = @level2name;\r\n \tEND\r\n END;\r\n+GO\n\\ No newline at end of file\n"
                },
                {
                    "date": 1758024321045,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,34 +1,60 @@\n+/*\r\n+# Description\r\n+Універсальна процедура для встановлення розширених властивостей на різних рівнях ієрархії об'єктів бази даних.\r\n+Підтримує встановлення властивостей для об'єктів на рівні схеми, таблиці, колонки тощо.\r\n+\r\n+# Parameters\r\n+@name NVARCHAR(128) - назва розширеної властивості\r\n+@value NVARCHAR(MAX) - значення властивості\r\n+@level0type NVARCHAR(128) = NULL - тип об'єкта рівня 0 (наприклад, 'SCHEMA')\r\n+@level0name NVARCHAR(128) = NULL - назва об'єкта рівня 0\r\n+@level1type NVARCHAR(128) = NULL - тип об'єкта рівня 1 (наприклад, 'TABLE')\r\n+@level1name NVARCHAR(128) = NULL - назва об'єкта рівня 1\r\n+@level2type NVARCHAR(128) = NULL - тип об'єкта рівня 2 (наприклад, 'COLUMN')\r\n+@level2name NVARCHAR(128) = NULL - назва об'єкта рівня 2\r\n+\r\n+# Returns\r\n+Нічого не повертає. Встановлює або оновлює розширену властивість\r\n+\r\n+# Usage\r\n+-- Встановити властивість для таблиці\r\n+EXEC util.metadataSetExtendedProperty @name = 'MS_Description', @value = 'Опис таблиці',\r\n+    @level0type = 'SCHEMA', @level0name = 'dbo', @level1type = 'TABLE', @level1name = 'myTable';\r\n+\r\n+-- Встановити властивість для колонки\r\n+EXEC util.metadataSetExtendedProperty @name = 'MS_Description', @value = 'Опис колонки',\r\n+    @level0type = 'SCHEMA', @level0name = 'dbo', @level1type = 'TABLE', @level1name = 'myTable',\r\n+    @level2type = 'COLUMN', @level2name = 'myColumn';\r\n+*/\r\n CREATE OR ALTER PROCEDURE [util].[metadataSetExtendedProperty]\r\n \t@name NVARCHAR(128),\r\n-\t@value NVARCHAR(max) = NULL,\r\n+\t@value NVARCHAR(MAX),\r\n \t@level0type NVARCHAR(128) = NULL,\r\n \t@level0name NVARCHAR(128) = NULL,\r\n \t@level1type NVARCHAR(128) = NULL,\r\n \t@level1name NVARCHAR(128) = NULL,\r\n \t@level2type NVARCHAR(128) = NULL,\r\n \t@level2name NVARCHAR(128) = NULL\r\n AS\r\n BEGIN\r\n-\tSET NOCOUNT ON;\r\n-\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n-\tDECLARE @varVal VARCHAR(4000) = @value\r\n-\t-- Перевірка на існування extended property\r\n-\tIF NOT EXISTS (\r\n-\t\tSELECT * \r\n-\t\tFROM sys.extended_properties\r\n-\t\tWHERE name = @name \r\n-\t\t\tAND ISNULL(@level0type, 'DATABASE') = 'DATABASE'\r\n-\t\t\tAND ISNULL(@level1type, '') = ISNULL(@level1type, '')\r\n-\t\t\tAND ISNULL(@level1name, '') = ISNULL(@level1name, '')\r\n-\t\t\tAND ISNULL(@level2type, '') = ISNULL(@level2type, '')\r\n-\t\t\tAND ISNULL(@level2name, '') = ISNULL(@level2name, '')\r\n+\t-- Check if property already exists\r\n+\tIF EXISTS (\r\n+\t\tSELECT 1 FROM sys.extended_properties \r\n+\t\tWHERE name = @name\r\n+\t\tAND major_id = ISNULL(OBJECT_ID(QUOTENAME(ISNULL(@level0name, '')) + '.' + QUOTENAME(ISNULL(@level1name, ''))), 0)\r\n+\t\tAND minor_id = ISNULL((\r\n+\t\t\tSELECT column_id \r\n+\t\t\tFROM sys.columns \r\n+\t\t\tWHERE object_id = OBJECT_ID(QUOTENAME(ISNULL(@level0name, '')) + '.' + QUOTENAME(ISNULL(@level1name, '')))\r\n+\t\t\tAND name = @level2name\r\n+\t\t), 0)\r\n \t)\r\n \tBEGIN\r\n-\t\t-- Додавання нового extended property\r\n-\t\tEXEC sys.sp_addextendedproperty\r\n+\t\t-- Update existing property\r\n+\t\tEXEC sys.sp_updateextendedproperty \r\n \t\t\t@name = @name,\r\n-\t\t\t@value = @varVal,\r\n+\t\t\t@value = @value,\r\n \t\t\t@level0type = @level0type,\r\n \t\t\t@level0name = @level0name,\r\n \t\t\t@level1type = @level1type,\r\n \t\t\t@level1name = @level1name,\r\n@@ -36,12 +62,12 @@\n \t\t\t@level2name = @level2name;\r\n \tEND\r\n \tELSE\r\n \tBEGIN\r\n-\t\t-- Оновлення існуючого extended property\r\n-\t\tEXEC sys.sp_updateextendedproperty\r\n+\t\t-- Add new property\r\n+\t\tEXEC sys.sp_addextendedproperty \r\n \t\t\t@name = @name,\r\n-\t\t\t@value = @varVal,\r\n+\t\t\t@value = @value,\r\n \t\t\t@level0type = @level0type,\r\n \t\t\t@level0name = @level0name,\r\n \t\t\t@level1type = @level1type,\r\n \t\t\t@level1name = @level1name,\r\n"
                }
            ],
            "date": 1757964521480,
            "name": "Commit-0",
            "content": "USE model; \r\nGO\r\nCREATE OR ALTER PROCEDURE [util].[metadataSetExtendedProperty]\r\n\t@name NVARCHAR(128),\r\n\t@value sql_variant = NULL,\r\n\t@level0type VARCHAR(128) = NULL,\r\n\t@level0name NVARCHAR(128) = NULL,\r\n\t@level1type VARCHAR(128) = NULL,\r\n\t@level1name NVARCHAR(128) = NULL,\r\n\t@level2type VARCHAR(128) = NULL,\r\n\t@level2name NVARCHAR(128) = NULL\r\nAS\r\nBEGIN\r\n\tSET NOCOUNT ON;\r\n\tSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n\t-- Перевірка на існування extended property\r\n\tIF NOT EXISTS (\r\n\t\tSELECT * \r\n\t\tFROM sys.extended_properties (NOLOCK) \r\n\t\tWHERE name = @name \r\n\t\t\tAND ISNULL(@level0type, 'DATABASE') = 'DATABASE'\r\n\t\t\tAND ISNULL(@level1type, '') = ISNULL(@level1type, '')\r\n\t\t\tAND ISNULL(@level1name, '') = ISNULL(@level1name, '')\r\n\t\t\tAND ISNULL(@level2type, '') = ISNULL(@level2type, '')\r\n\t\t\tAND ISNULL(@level2name, '') = ISNULL(@level2name, '')\r\n\t)\r\n\tBEGIN\r\n\t\t-- Додавання нового extended property\r\n\t\tEXEC sys.sp_addextendedproperty\r\n\t\t\t@name = @name,\r\n\t\t\t@value = @value,\r\n\t\t\t@level0type = @level0type,\r\n\t\t\t@level0name = @level0name,\r\n\t\t\t@level1type = @level1type,\r\n\t\t\t@level1name = @level1name,\r\n\t\t\t@level2type = @level2type,\r\n\t\t\t@level2name = @level2name;\r\n\tEND\r\n\tELSE\r\n\tBEGIN\r\n\t\t-- Оновлення існуючого extended property\r\n\t\tEXEC sys.sp_updateextendedproperty\r\n\t\t\t@name = @name,\r\n\t\t\t@value = @value,\r\n\t\t\t@level0type = @level0type,\r\n\t\t\t@level0name = @level0name,\r\n\t\t\t@level1type = @level1type,\r\n\t\t\t@level1name = @level1name,\r\n\t\t\t@level2type = @level2type,\r\n\t\t\t@level2name = @level2name;\r\n\tEND\r\nEND;\r\nGO"
        }
    ]
}